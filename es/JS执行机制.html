<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JS 的执行机制 | 前端笔记</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="JINJITING 的前端学习笔记。">
    
    <link rel="preload" href="/fe-notes/assets/css/0.styles.11c32323.css" as="style"><link rel="preload" href="/fe-notes/assets/js/app.5bf03349.js" as="script"><link rel="preload" href="/fe-notes/assets/js/2.08feea58.js" as="script"><link rel="preload" href="/fe-notes/assets/js/11.fc301195.js" as="script"><link rel="prefetch" href="/fe-notes/assets/js/10.65d3a43f.js"><link rel="prefetch" href="/fe-notes/assets/js/12.2ad63311.js"><link rel="prefetch" href="/fe-notes/assets/js/13.4d78dbf4.js"><link rel="prefetch" href="/fe-notes/assets/js/14.d1e5417b.js"><link rel="prefetch" href="/fe-notes/assets/js/15.d1e39632.js"><link rel="prefetch" href="/fe-notes/assets/js/16.2fee1dce.js"><link rel="prefetch" href="/fe-notes/assets/js/17.9d3df443.js"><link rel="prefetch" href="/fe-notes/assets/js/18.5e358cad.js"><link rel="prefetch" href="/fe-notes/assets/js/19.a9ee5e34.js"><link rel="prefetch" href="/fe-notes/assets/js/20.62f07cd9.js"><link rel="prefetch" href="/fe-notes/assets/js/21.5d91ef00.js"><link rel="prefetch" href="/fe-notes/assets/js/22.3888d3cd.js"><link rel="prefetch" href="/fe-notes/assets/js/23.8f8af772.js"><link rel="prefetch" href="/fe-notes/assets/js/24.5ba70534.js"><link rel="prefetch" href="/fe-notes/assets/js/25.7773ff06.js"><link rel="prefetch" href="/fe-notes/assets/js/26.530cc259.js"><link rel="prefetch" href="/fe-notes/assets/js/3.b422ad30.js"><link rel="prefetch" href="/fe-notes/assets/js/4.18a9b86e.js"><link rel="prefetch" href="/fe-notes/assets/js/5.7ab9c794.js"><link rel="prefetch" href="/fe-notes/assets/js/6.605733ee.js"><link rel="prefetch" href="/fe-notes/assets/js/7.48ac54af.js"><link rel="prefetch" href="/fe-notes/assets/js/8.568f89d0.js"><link rel="prefetch" href="/fe-notes/assets/js/9.6138a6cd.js">
    <link rel="stylesheet" href="/fe-notes/assets/css/0.styles.11c32323.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fe-notes/" class="home-link router-link-active"><!----> <span class="site-name">前端笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fe-notes/es/0.html" class="nav-link">
  JS/ES
</a></div><div class="nav-item"><a href="/fe-notes/ide/0.html" class="nav-link">
  IDE
</a></div><div class="nav-item"><a href="/fe-notes/extension/ISO-8859-1.html" class="nav-link">
  扩展
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fe-notes/es/0.html" class="nav-link">
  JS/ES
</a></div><div class="nav-item"><a href="/fe-notes/ide/0.html" class="nav-link">
  IDE
</a></div><div class="nav-item"><a href="/fe-notes/extension/ISO-8859-1.html" class="nav-link">
  扩展
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fe-notes/es/this.html" class="sidebar-link">this 指向</a></li><li><a href="/fe-notes/es/debounce-and-throttle.html" class="sidebar-link">防抖与节流</a></li><li><a href="/fe-notes/es/JS执行机制.html" class="active sidebar-link">JS 执行机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-notes/es/JS执行机制.html#提升-hoisting" class="sidebar-link">提升（Hoisting）</a></li><li class="sidebar-sub-header"><a href="/fe-notes/es/JS执行机制.html#调用栈-call-stack" class="sidebar-link">调用栈（call Stack）</a></li><li class="sidebar-sub-header"><a href="/fe-notes/es/JS执行机制.html#作用域-scope" class="sidebar-link">作用域（scope）</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="js-的执行机制"><a href="#js-的执行机制" class="header-anchor">#</a> JS 的执行机制</h1> <h2 id="提升-hoisting"><a href="#提升-hoisting" class="header-anchor">#</a> 提升（Hoisting）</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'js'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">fun</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>以上代码等同于:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//fn 函数是完整的函数声明</span>
<span class="token keyword">function</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//声明</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> name<span class="token punctuation">;</span><span class="token comment">//声明</span>
name <span class="token operator">=</span> <span class="token string">'js'</span><span class="token punctuation">;</span><span class="token comment">//赋值</span>
<span class="token keyword">var</span> fun<span class="token punctuation">;</span><span class="token comment">//声明</span>
<span class="token function-variable function">fun</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//赋值</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>变量提升</strong>，指在 JS 代码执行过程中，（表面上）将变量的声明和函数的声明部分提升到代码开头。<strong>变量提升后，会设置默认值 undefined</strong>。实际上，<strong>代码的位置并没有改变，而是在编译阶段被 JS 引擎放入内存中</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//undefined</span>
<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token string">'x'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/** 执行上下文中的变量环境
 * function log(x){ console.log(x) }
 * var x;
 */</span>
<span class="token comment">/** 可执行代码
 * log(x);
 * x = 'x';
 */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>编译阶段</strong>，JS 的代码会生成两部分内容：<strong>执行上下文（Execution content）和可执行代码</strong>。
<strong>执行上下文是 JS 执行一段代码时的运行环境</strong>，确定在执行时用到的 this、变量、对象以及函数等。执行上下文由<strong>变量环境组件（Variable Environment）、词法环境组件（Lexical Environment）、this 绑定</strong>3个组件组成。(变量环境组件和词法环境组件始终为词法环境对象)</p> <p><strong>变量环境</strong>，该对象中保存着变量提升的内容。一般来说，有3种情况:</p> <ul><li>执行全局代码时，JS 引擎编译并创建全局执行上下文，整个页面的生存周期内只有一个。</li> <li>调用函数时，编译函数体内的代码并创建函数执行上下文，一般函数执行结束后就会被销毁。</li> <li>使用 eval 函数时，eval 的代码编译并创建执行上下文。</li></ul> <p><strong>执行阶段</strong>，JS 引擎执行“可执行代码”，并按照顺序执行。在上面的代码中，先执行 log 函数，此时变量x没有赋值，取 undefined；接着执行赋值步骤，此时变量“x = 'x'”。</p> <p><strong>注意</strong>：</p> <ul><li>如果有两个相同的函数，后定义的会覆盖之前定义的。</li> <li>函数提升在变量提升之前。</li></ul> <h3 id="变量提升带来的问题"><a href="#变量提升带来的问题" class="header-anchor">#</a> 变量提升带来的问题</h3> <ol><li>变量覆盖</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'global-name'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">logName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'fn-name'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'fn-name'</span>
<span class="token punctuation">}</span>
<span class="token function">logName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//在 logName 函数执行时，var name 变量声明提升至 logName 的函数执行上下文中，默认值为 undefined</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="2"><li>本应销毁的变量没有销毁</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="调用栈-call-stack"><a href="#调用栈-call-stack" class="header-anchor">#</a> 调用栈（call Stack）</h2> <p>在执行上下文创建后，JS 引擎会用栈来管理执行上下文，这个栈即调用栈。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">plus</span><span class="token punctuation">(</span><span class="token parameter">a，b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打印栈结构</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">plusTen</span><span class="token punctuation">(</span><span class="token parameter">a，b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">plus</span><span class="token punctuation">(</span>a，b<span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">plusTen</span><span class="token punctuation">(</span><span class="token number">1</span>，<span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在上面代码中，调用栈变化如下:</p> <ol><li>创建全局上下文，并压入栈底。变量 a，函数 plus、plusTen 都在变量环境对象中。（然后执行代码）</li> <li>调用 plusTen 时，JS 编译该函数并创建执行上下文，然后压入栈中。变量x在该执行上下文的变量环境中</li> <li>调用 plus 函数创建执行上下文并压入栈中。</li> <li>执行 plus 中代码后，返回结果6，并销毁 plus 函数的执行上下文。接着返回 plusTen 中的结果16，并销毁执行上下文。最后，剩下全局执行上下文。</li></ol> <p><strong>注意</strong>：当分配的栈空间被占满时，会引起“栈溢出”的错误。</p> <h2 id="作用域-scope"><a href="#作用域-scope" class="header-anchor">#</a> 作用域（scope）</h2> <p>作用域是指在程序中定义变量的区域，决定了变量的生命周期。作用域就是变量和函数可访问的范围。
<strong>全局作用域</strong>中的对象在代码中的任何地方都能访问，生命周期伴随着页面的生命周期；
<strong>函数作用域</strong>就是在函数内部定义的变量或函数只能在函数内部被访问；
<strong>块级作用域</strong>就是使用大括号包含的一段代码，如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">//if块</span>
<span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">//函数块</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">//for循环块</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>ES6通过let和const实现块级作用域。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span>
  <span class="token comment">//console.log(a);//Cannot access 'a' before initialization</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> d <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//11</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//3</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//error:d is not defined</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>上面代码中，全局执行上下文变化如下:</p> <ol><li>编译并创建执行上下文，将保存变量 a、c，将 b 保存在词法环境中，并压入栈底（var 声明的变量存放在变量环境中；let 和 const 声明创建的变量在词法环境中）</li> <li>执行代码，当执行到块里面的代码时，将块内的变量压到栈顶。</li> <li>当执行到 console.log(b) 时，在词法环境栈由上到下，查找变量 b，没有找到则往变量环境中查找。</li> <li>执行完对应的代码后，销毁对应的块级作用域。</li></ol> <p><strong>作用域链（scope chain）</strong> 即 JS 引擎查找某个变量的链条。</p> <p><strong>词法作用域</strong>：代码中由变量和函数声明位置决定的作用域（静态作用域）。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">6/28/2020, 1:15:15 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe-notes/es/debounce-and-throttle.html" class="prev">
        防抖与节流
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/fe-notes/assets/js/app.5bf03349.js" defer></script><script src="/fe-notes/assets/js/2.08feea58.js" defer></script><script src="/fe-notes/assets/js/11.fc301195.js" defer></script>
  </body>
</html>
